---
title: Zipcodes' Distance to Fires
author: Angela Zhao
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE, dpi=500}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)
library(sf)
library(ussf)
library(zipcode)
library(lubridate)
library(haven)




# Parameters
file_raw_survey <- here::here("data/STAN0128_main_OUTPUT.rds")

file_zipcodes_ca_geometry <-
  here::here("data/ca_zipcodes/ca_zipcodes.shp")

file_raw_fire_perim <- 
  here::here("data/frap_fire_perim_firep19_1_shp/firep19_1.shp")

file_out_zipcodes_fire_ca <-
  here::here("data/zipcodes_fire_ca_final_product_shp/zipcodes_fire_ca.shp")

file_out_zipcodes_fire_ca_untidy <-
  here::here("data/zipcodes_fire_ca_untidy_final_product_shp/zipcodes_fire_ca_untidy.shp")

# PROJ string for CA
CA_ALBERS <- 
  "+proj=aea +lat_1=34 +lat_2=40.5 +lat_0=0 +lon_0=-120 +x_0=0 +y_0=-4000000 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"

CA_ALBERS_EPSG <- 3310

```


## Notes:

zipcodes_fires_ca: final tibble with all the good stuff in it. Contains zipcodes, geoid, geometry of the zipcodes' buffers at 3, 5, 10 miles, and number of fires 3, 5, 10 miles away from 2017-2019 nd 2018-2019. 

### Troubleshooting st_intersects and st_crs w/ buffer
Used CA_ALBERS_ESPG as opposed to CA_ALBERS because the projection wasn't sticking to the buffer otherwise.

So gdb files contain multisurface and is a limitation not of sf but of GEOS. This means that  st_intersects refuses to work with multisurface and gives off the error:
Error in CPL_geos_binop(st_geometry(x), st_geometry(y), op, par, pattern, : Evaluation error:  ParseException: Unknown WKB type 12.

Code given: st_intersects(test$buffer_shape, test$fire_geometry)
Two paths: either turn it into a multipolygon and hope that the multisurface goes away, or import the layer of interest in the gdb as a shapefile.
    Consider "test" as a df. 
     How to find if multisurface: unique(st_geometry_type(st_geometry(test$fire_geometry or foo)))
     To cast to a different shape: st_cast(test$fire_geometry, "POLYGON")
     To change st_intersect result, an sgbp, into vector:
         a <- st_intersects(test$buffer_shape, test$fire_geometry)
         sel_logical = lengths(a) > 0

## Reading in wildfires data
```{r}
# Function for reading in wildfires

read_wildfires <- function() {
  file_raw_fire_perim %>% 
    read_sf() %>% 
    rename_all(tolower) %>% 
    rename(
      geometry_length = shape_leng,
      geometry_area = shape_area,
      year = year_
    ) %>% 
    select(
      year, 
      fire_name, 
      alarm_date, 
      cont_date, 
      gis_acres, 
      fire_num, 
      geometry_length, 
      geometry_area, 
      geometry
    )
}

wildfires_2017_19 <-
  read_wildfires() %>% 
  filter(alarm_date >= "2017/08/15", year %in% c("2017","2018", "2019")) 
 

wildfires_2018_19 <-
  read_wildfires() %>% 
  filter(alarm_date >= "2018/08/15", year %in% c("2018","2019"))


```
# Data Wrangling

## Reading in Zipcode Data

```{r}
data(zipcode)

zipcodes_ca <-
  zipcode %>% 
  filter(state == "CA") %>% 
  distinct(zip)

zipcodes_survey_ca <-
  file_raw_survey %>% 
  read_dta() %>% 
  mutate_if(is.labelled, as_factor) %>%
  rename(zip = inputzip) %>% 
  filter(str_detect(consent, "Yes"), zip %in% zipcodes_ca$zip) %>% 
  distinct(zip)

```

## Plotting zipcodes onto the map

```{r}
# From the zipcode package

create_buffer <- function(data, radius) {
  data %>% 
  st_buffer(units::set_units(radius, "miles")) %>% 
    st_transform(crs = CA_ALBERS) %>% 
    st_transform(CA_ALBERS_EPSG)
}

# These are the zipcodes that are in CA and found in the survey. They also have centroid, general zipcode polygon, and buffer data. 
zipcodes_ca_geometry <-
  file_zipcodes_ca_geometry %>% 
  read_sf() %>% 
  rename(zipcode = name) %>% 
  filter(zipcode %in% zipcodes_survey_ca$zip) %>% 
  st_transform(crs = CA_ALBERS) %>% 
  rename(
    zipcode_geometry = geometry
  ) %>% 
  mutate(
    zipcode_centroid = st_centroid(zipcode_geometry),
    "3_mile_buffer" = create_buffer(zipcode_centroid, 3), 
    "5_mile_buffer" = create_buffer(zipcode_centroid, 5),
    "10_mile_buffer" = create_buffer(zipcode_centroid, 10)
  ) %>% 
  select(-c(B00001001, B00001001e))

# st_crs(zipcodes_ca_geometry$`10_mile_buffer`)

```

## Plotting CA and Zipcodes on a map

```{r}
ca <- 
  boundaries(geography = "state", resolution = "500k", projection = "albers") %>% 
  filter(NAME == "California") %>% 
  st_transform(crs = CA_ALBERS) 


plot_zipcodes <- function(data) {
  ca %>% 
  ggplot() +
  geom_sf() +
  geom_sf(aes(alpha = 0.05), data = data) +
  theme_void()
}

# Plotting zipcodes as district boundaries

plot_zipcodes(zipcodes_ca_geometry) 

# Plotting zipcode centroid points

plot_zipcodes(zipcodes_ca_geometry$zipcode_centroid) 

# Plotting zipcodes in 3, 5, and 10 mile radii 

plot_zipcodes(zipcodes_ca_geometry$`3_mile_buffer`)

plot_zipcodes(zipcodes_ca_geometry$`5_mile_buffer`)

plot_zipcodes(zipcodes_ca_geometry$`10_mile_buffer`)


```

## Plotting fires on top of zipcode centroids 

```{r}
# Use the geometry to identify which column's geometry within the tibble to use. 

ggplot() +
  geom_sf(data = ca) + 
  geom_sf(
    aes(
      geometry = zipcode_centroid, 
      alpha = 0.05
    ), 
    data = zipcodes_ca_geometry, 
    show.legend = "point"
  ) + 
  geom_sf(data = wildfires_2018_19, color = "red")

ggplot() +
  geom_sf(data = ca) + 
  geom_sf(
    aes(
      geometry = zipcode_centroid, 
      alpha = 0.05
    ), 
    data = zipcodes_ca_geometry, 
    show.legend = "point"
  ) + 
  geom_sf(data = wildfires_2017_19, color = "red")

```
## Looking at overlaps between zip code buffers of 3, 5, 10 miles from geometry of fires

## Created a tidy tibble of zipcodes, geometry, centroid, buffer_radius, and buffer geometry
```{r}

zipcodes_fires_ca <-
  zipcodes_ca_geometry %>% 
  pivot_longer(
    cols = c("3_mile_buffer":"10_mile_buffer"), 
    names_to = "buffer_radius(miles)", 
    values_to = "buffer_shape"
  ) %>% 
  mutate(
    "buffer_radius(miles)" = 
      str_extract(`buffer_radius(miles)`, "\\d+") %>% as.double()
  )
  
```


## Running fire_intersect using map_dfr and functions
```{r}

fires_intersect_buffer_2017_2019 <- function(buffer_shape) {
    st_intersects(buffer_shape, wildfires_2017_19$geometry, sparse = FALSE) %>% 
    sum()
}

fires_intersect_buffer_2018_2019 <- function(buffer_shape) {
    st_intersects(buffer_shape, wildfires_2018_19$geometry, sparse = FALSE) %>% 
    sum()
}

tibble_fires_intersect_buffer_2017_2019 <-
  zipcodes_fires_ca %>% 
  pull(buffer_shape) %>% 
  map_dfr(safely(fires_intersect_buffer_2017_2019)) 

tibble_fires_intersect_buffer_2018_2019 <-
  zipcodes_fires_ca %>% 
  pull(buffer_shape) %>% 
  map_dfr(safely(fires_intersect_buffer_2018_2019)) 

tibble_fires_intersect_buffer_2017_2019 <-
  tibble_fires_intersect_buffer_2017_2019 %>% 
  rename(num_fires_2017_2019 = result)
  
tibble_fires_intersect_buffer_2018_2019 <-
  tibble_fires_intersect_buffer_2018_2019 %>% 
  rename(num_fires_2018_2019 = result)

zipcodes_fires_ca <-
  zipcodes_fires_ca %>% 
  bind_cols(tibble_fires_intersect_buffer_2018_2019) %>% 
  bind_cols(tibble_fires_intersect_buffer_2017_2019)


```

## Reading the finished, tidied tibble into a data set

```{r}
zipcodes_fires_ca %>% 
  rename(
    "2018-2019" = "num_fires_2018_2019", 
    "2017-2019" = "num_fires_2017_2019"
  ) %>% 
  pivot_longer(
    names_to = "years", 
    values_to = "num", 
    cols = c("2018-2019", "2017-2019")
  ) %>% 
  write_sf(file_out_zipcodes_fire_ca)

zipcodes_fires_ca %>% 
  write_sf(file_out_zipcodes_fire_ca_untidy)

# Merge back into CA poll



```


# Presenting of various graphs

## Graphing the frequency of fires in a certain radius around zipcode

```{r}

graph_freq_fires_radius <- function(rad) {
  zipcodes_fires_ca %>% 
  filter(`buffer_radius(miles)` == {{rad}}) %>% 
  select(starts_with("num")) %>% 
  rename(
    "2018-2019" = "num_fires_2018_2019", 
    "2017-2019" = "num_fires_2017_2019"
  ) %>% 
  pivot_longer(
    names_to = "years", 
    values_to = "num", 
    cols = c("2018-2019", "2017-2019")
  ) %>% 
  count(years, num) %>% 
  ggplot(aes(x = num, y = n, fill = years)) +
  geom_col(position = "dodge") +
  labs(
    x = str_c("Number of fires within ", rad, " miles of zipcode"), 
    y = "Frequency in CA"
  )
}


map(c(3, 5, 10), graph_freq_fires_radius)

```

## Counting distances and numbers of fires experienced over the years

```{r}
zipcodes_fires_ca %>% 
  filter(num_fires_2018_2019 > 0, num_fires_2017_2019 > 0) %>% 
  rename(
    "2018-2019" = "num_fires_2018_2019", 
    "2017-2019" = "num_fires_2017_2019"
  ) %>% 
  pivot_longer(
    names_to = "years", 
    values_to = "num", 
    cols = c("2018-2019", "2017-2019")
  ) %>% 
  count(`buffer_radius(miles)`, years)

```

## Mapping out areas that experienced fire

```{r}
plot_zipcodes_filter_2017 <- function(rad) {
  data <-
    zipcodes_fires_ca %>% 
    filter(
      num_fires_2017_2019 > 0, 
      `buffer_radius(miles)` == rad
    ) %>% 
    distinct(zipcode, buffer_shape) %>% 
    pull(buffer_shape)
  

  ca %>% 
    ggplot() +
    geom_sf() +
    geom_sf(aes(alpha = 0.05), data = data) +
    geom_sf(data = wildfires_2018_19, color = "red") + 
    theme_void()
}


plot_zipcodes_filter_2018 <- function(rad) {
  data <-
    zipcodes_fires_ca %>% 
    filter(
      num_fires_2018_2019 > 0,
      `buffer_radius(miles)` == rad
    ) %>% 
    distinct(zipcode, buffer_shape) %>% 
    pull(buffer_shape)
  
  ca %>% 
    ggplot() +
    geom_sf() +
    geom_sf(aes(alpha = 0.05), data = data) +
    geom_sf(data = wildfires_2018_19, color = "red") +
    theme_void()
}

 ca %>% 
    ggplot() +
    geom_sf() +
    geom_sf(data = wildfires_2018_19, color = "red") + 
    theme_void()
 
  ca %>% 
    ggplot() +
    geom_sf() +
    geom_sf(data = wildfires_2017_19, color = "red") + 
    theme_void()


map(c(3, 5, 10), plot_zipcodes_filter_2017)
map(c(3, 5, 10), plot_zipcodes_filter_2018)


```


